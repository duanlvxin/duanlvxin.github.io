---
title: vite
date: 2025-05-26 23:42:25
tags:
 - js 模块 打包
categories:
 - js
bg_size: auto
---

### 介绍
Vite 是一个前端构建工具，在开发环境下具有快速冷启动、即时热更新等特性，生产环境则能输出优化后的静态资源。下面从开发环境和生产环境两个方面介绍其原理。

### 开发环境
Vite 在开发环境采用 **原生 ES 模块（ESM）** 来实现快速启动和更新，主要步骤如下：
1. **服务器启动**：Vite 启动一个开发服务器，监听本地端口。启动时不会对项目代码进行全量打包，因此启动速度极快。
2. **浏览器请求模块**：当浏览器加载 HTML 文件时，遇到 `<script type="module">` 标签，会根据 ES 模块规范向服务器发起请求获取各个模块。
3. **按需编译和转换**：服务器接收到模块请求后，对文件进行按需处理。例如，将 TypeScript 转换为 JavaScript，将 Vue 单文件组件拆分为模板、脚本和样式等部分。
4. **模块加载**：处理后的模块以原生 ES 模块形式返回给浏览器，浏览器按照依赖关系依次加载执行。
5. **热更新（HMR）**：当文件发生变化时，Vite 会通过 WebSocket 与浏览器建立连接，检测到文件变化后，仅将变化的模块推送给浏览器，实现局部更新，无需重新加载整个页面。

### 生产环境
Vite 在生产环境使用 **Rollup** 进行打包，主要步骤如下：
1. **依赖分析**：分析项目中的模块依赖关系，构建依赖图。
2. **代码打包**：根据依赖图将所有模块打包成一个或多个文件，减少 HTTP 请求次数。
3. **代码优化**：对打包后的代码进行压缩、Tree Shaking（移除未使用的代码）、代码分割等优化操作，减小文件体积，提高加载速度。
4. **资源输出**：将优化后的代码和其他静态资源输出到指定目录，用于部署。

### 示例代码体现 Vite 特性
在 Vite 项目中，使用原生 ES 模块导入导出示例：
```js
// utils.ts
export const add = (a: number, b: number) => a + b;

// main.ts
import { add } from './utils.ts';
console.log(add(1, 2));
```

在开发环境下，浏览器会直接请求 utils.ts 和 main.ts 文件，Vite 服务器按需处理这些文件。生产环境中，Rollup 会将这两个文件打包成一个优化后的文件。

综上所述，Vite 利用原生 ES 模块在开发环境实现快速响应，借助 Rollup 在生产环境生成高效的打包文件，为开发者提供了高效的开发体验和优化的生产构建。